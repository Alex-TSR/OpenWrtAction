#
# Copyright (c) 2022-2023 SMALLPROGRAM <https://github.com/smallprogram/OpenWrtAction>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#
# https://github.com/smallprogram/OpenWrtAction
# Description: Build OpenWrt using GitHub Actions
#

name: Build-OpenWrtSelfHost

on:
  repository_dispatch:
    types: [openwrt_source_update]
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'
      is_display_detailed:
        description: 'Whether to display detailed information about compilation'
        required: false
        default: 'false'
      is_single_threaded:
        description: 'Whether single-threaded compilation'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: self-hosted

    steps:
    - name: Checkout
      uses: actions/checkout@main

    - name: Compile X86 Firmware
      id: compile
      run: |
        cd /home/$USER
        if [ ! -d "/home/$USER/OpenWrtAction" ]; then 
          git clone https://github.com/smallprogram/OpenWrtAction.git; 
        else 
          cd /home/$USER/OpenWrtAction; 
          git stash; 
          git stash drop; 
          git pull; 
        fi;
        cd /home/$USER/OpenWrtAction; 
        bash wsl2op_lean.sh X86.config